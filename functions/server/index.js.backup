import express from 'express';
import cors from 'cors';
import path from 'path';
import fs from 'fs';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import os from 'os';
import { createServer } from 'http';
import { AGENCIES, getAllAgencies } from './agencyData.js';
import { setupUserRoutes, authenticateToken, requireRole } from './userRoutes.js';
import { createPool, createDemoDataProvider } from './database.js';
import hybridDb from './hybridDatabase.js';
import compression from 'compression';

// Global error handlers for better debugging
process.on('uncaughtException', (error) => {
  console.error('âŒ Uncaught Exception:', error);
  console.error('Stack trace:', error.stack);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('âŒ Unhandled Rejection at:', promise, 'reason:', reason);
  console.error('Stack trace:', reason?.stack);
  process.exit(1);
});

// Load environment variables
dotenv.config();

// ES modules compatibility
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const app = express();
const PORT = parseInt(process.env.PORT || '3001');

// LDAP configuration (will be loaded from environment or database in production)
let ldapConfig = {
  enabled: false,
  url: 'ldap://your-domain-controller.com',
  baseDN: 'dc=example,dc=com',
  bindDN: 'cn=admin,dc=example,dc=com',
  bindCredentials: 'admin_password',
  userSearchBase: 'ou=users,dc=example,dc=com',
  userSearchFilter: '(sAMAccountName={{username}})',
  groupSearchBase: 'ou=groups,dc=example,dc=com',
  groupSearchFilter: '(member={{dn}})',
  adminGroup: 'CN=Admins,OU=Groups,DC=example,DC=com',
  auditorGroup: 'CN=Auditors,OU=Groups,DC=example,DC=com'
};

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(compression()); // Add compression for better performance

// DÃ©terminer si on est en mode dÃ©mo complet
const isDemoMode = process.env.DEMO_MODE === 'true';

// Architecture hybride: MySQL + Informix
let dataProvider;
let mysqlPool;
let informixPool;
let dbConfig;

// Initialiser la base de donnÃ©es hybride
if (isDemoMode) {
  console.log('ðŸŽ­ Mode DEMO COMPLET activÃ© - DonnÃ©es fictives');
  dataProvider = createDemoDataProvider();

  mysqlPool = {
    getConnection: async () => ({
      query: async () => [[]],
      release: () => {}
    }),
    end: () => {}
  };

  dbConfig = {
    mysql: { available: false },
    informix: { available: false },
    demoProvider: dataProvider
  };
} else {
  console.log('ðŸ”„ Mode PRODUCTION - Architecture hybride');
  dbConfig = await hybridDb.initializeHybridDatabase();
  mysqlPool = dbConfig.mysql.pool;
  informixPool = dbConfig.informix.pool;
  dataProvider = dbConfig.demoProvider;
}

// Function to get MySQL connection (for auth, rules, users)
const getMySQLConnection = async () => {
  if (!dbConfig.mysql.available) {
    throw new Error('MySQL not available. Cannot perform authentication operations.');
  }
  try {
    return await mysqlPool.getConnection();
  } catch (error) {
    console.error('Error getting MySQL connection:', error);
    throw new Error('MySQL connection failed');
  }
};

// Legacy function for backward compatibility (defaults to MySQL for auth)
const getConnection = getMySQLConnection;

// Helper functions for data access
const getBusinessData = async (query, params = []) => {
  if (dbConfig.informix.available) {
    return await hybridDb.executeInformixQuery(query, params);
  } else {
    if (!dataProvider) {
      throw new Error('No data source available');
    }
    return null;
  }
};

const isBusinessDataAvailable = () => dbConfig.informix.available;

// Setup user routes (MySQL for authentication)
setupUserRoutes(app, getConnection);

// Health check endpoint
app.get('/api/health', async (req, res) => {
  try {
    let totalRecords = 0;
    
    if (isDemoMode) {
      // Use demo data
      const clientStats = dataProvider.getClientStats();
      totalRecords = clientStats.total;
    } else {
      // Use real database
      const connection = await getConnection();
      const [rows] = await connection.query('SELECT COUNT(*) as count FROM bkcli');
      totalRecords = rows[0].count;
      connection.release();
    }

    res.json({
      status: 'ok',
      message: `Server is running${isDemoMode ? ' in demo mode' : ''}`,
      timestamp: new Date().toISOString(),
      totalRecords
    });
  } catch (error) {
    console.error('Health check error:', error);
    res.status(500).json({
      status: 'error',
      message: 'Database connection failed',
      error: error.message
    });
  }
});

// Get client statistics
app.get('/api/stats/clients', async (req, res) => {
  try {
    if (isDemoMode || !isBusinessDataAvailable()) {
      // Use demo data
      const clientStats = dataProvider.getClientStats();
      res.json(clientStats);
    } else {
      // Use Informix for business data
      const totalResult = await getBusinessData('SELECT COUNT(*) as count FROM bkcli');
      const [individualResult] = await getBusinessData('SELECT COUNT(*) as count FROM bkcli WHERE tcli = "1"');
      const [individualResult] = await connection.query('SELECT COUNT(*) as count FROM bkcli WHERE tcli = "1"');
      const [corporateResult] = await connection.query('SELECT COUNT(*) as count FROM bkcli WHERE tcli = "2"');
      const [institutionalResult] = await connection.query('SELECT COUNT(*) as count FROM bkcli WHERE tcli = "3"');
      
      // Calculate anomalies count with comprehensive rules
      const [anomaliesResult] = await connection.query(`
        SELECT COUNT(*) as count FROM bkcli 
        WHERE 
          /* Common rules for all client types */
          (cli IS NULL OR TRIM(cli) = '' OR tcli NOT IN ('1', '2', '3') OR age IS NULL OR TRIM(age) = '')
          
          /* Rules for individual clients (tcli = 1) */
          OR (tcli = '1' AND (
            nid IS NULL OR TRIM(nid) = '' OR 
            (nid IS NOT NULL AND (LENGTH(nid) < 8 OR nid LIKE '%123%' OR nid LIKE '%XXX%' OR nid LIKE '%000%')) OR
            nmer IS NULL OR TRIM(nmer) = '' OR 
            dna IS NULL OR dna < '1915-01-01' OR dna > CURDATE() OR
            (vid IS NOT NULL AND vid < CURDATE()) OR
            nat IS NULL OR TRIM(nat) = '' OR
            nom IS NULL OR TRIM(nom) = '' OR nom REGEXP '^[Xx]+$' OR
            pre IS NULL OR TRIM(pre) = '' OR pre REGEXP '^[Xx]+$' OR
            sext NOT IN ('M', 'F') OR
            viln IS NULL OR TRIM(viln) = '' OR
            payn IS NULL OR TRIM(payn) = '' OR
            tid IS NULL OR TRIM(tid) = ''
          ))
          
          /* Rules for corporate clients (tcli = 2) */
          OR (tcli = '2' AND (
            rso IS NULL OR TRIM(rso) = '' OR rso LIKE '%123%' OR rso LIKE '%XXX%' OR
            (sig IS NOT NULL AND (LENGTH(sig) > 20 OR sig NOT REGEXP '^[A-Z0-9\\-\\.\\s]+$')) OR
            nrc IS NULL OR TRIM(nrc) = '' OR nrc LIKE '%123%' OR nrc LIKE '%XXX%' OR nrc LIKE '%000%' OR nrc NOT LIKE 'MA%' OR
            datc IS NULL OR datc < '1915-01-01' OR datc > CURDATE() OR
            sec IS NULL OR TRIM(sec) = '' OR
            fju IS NULL OR TRIM(fju) = '' OR
            catn IS NULL OR TRIM(catn) = '' OR
            lienbq IS NULL OR TRIM(lienbq) = ''
          ))
          
          /* Rules for institutional clients (tcli = 3) */
          OR (tcli = '3' AND (
            rso IS NULL OR TRIM(rso) = '' OR rso LIKE '%123%' OR rso LIKE '%XXX%' OR
            nrc IS NULL OR TRIM(nrc) = '' OR nrc LIKE '%123%' OR nrc LIKE '%XXX%' OR nrc LIKE '%000%' OR
            datc IS NULL OR datc < '1915-01-01' OR datc > CURDATE() OR
            sec IS NULL OR TRIM(sec) = '' OR
            fju IS NULL OR TRIM(fju) = '' OR
            catn IS NULL OR TRIM(catn) = '' OR
            lienbq IS NULL OR TRIM(lienbq) = ''
          ))
      `);
      
      // Get FATCA count
      const [fatcaResult] = await connection.query(`
        SELECT COUNT(*) as count FROM bkcli 
        WHERE tcli = "1" AND (
          payn = "US" OR nat = "US" OR 
          EXISTS (SELECT 1 FROM bkadcli WHERE bkadcli.cli = bkcli.cli AND bkadcli.cpay = "US") OR
          EXISTS (SELECT 1 FROM bktelcli WHERE bktelcli.cli = bkcli.cli AND (
            bktelcli.num LIKE "+1%" OR 
            bktelcli.num LIKE "001%" OR 
            bktelcli.num LIKE "+01%" OR 
            bktelcli.num LIKE "+001%"
          ))
        )
      `);
      
      connection.release();
      
      res.json({
        total: totalResult[0].count,
        individual: individualResult[0].count,
        corporate: corporateResult[0].count,
        institutional: institutionalResult[0].count,
        anomalies: anomaliesResult[0].count,
        fatca: fatcaResult[0].count
      });
    }
  } catch (error) {
    console.error('Error getting client statistics:', error);
    res.status(500).json({ error: 'Failed to retrieve client statistics' });
  }
});

// Get validation metrics
app.get('/api/validation-metrics', async (req, res) => {
  try {
    // Use demo data
    const validationMetrics = dataProvider.getValidationMetrics();
    res.json(validationMetrics);
  } catch (error) {
    console.error('Error getting validation metrics:', error);
    res.status(500).json({ error: 'Failed to retrieve validation metrics' });
  }
});

// Get individual anomalies
app.get('/api/anomalies/individual', async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    
    // Use demo data
    const result = dataProvider.getIndividualAnomalies(page, limit);
    res.json(result);
  } catch (error) {
    console.error('Error getting individual anomalies:', error);
    res.status(500).json({ error: 'Failed to retrieve individual anomalies' });
  }
});

// Get corporate anomalies
app.get('/api/anomalies/corporate', async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    
    // Use demo data
    const result = dataProvider.getCorporateAnomalies(page, limit);
    res.json(result);
  } catch (error) {
    console.error('Error getting corporate anomalies:', error);
    res.status(500).json({ error: 'Failed to retrieve corporate anomalies' });
  }
});

// Get institutional anomalies
app.get('/api/anomalies/institutional', async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    
    // Use demo data
    const result = dataProvider.getInstitutionalAnomalies(page, limit);
    res.json(result);
  } catch (error) {
    console.error('Error getting institutional anomalies:', error);
    res.status(500).json({ error: 'Failed to retrieve institutional anomalies' });
  }
});

// Get anomalies by branch
app.get('/api/anomalies/by-branch', async (req, res) => {
  try {
    // Use demo data
    const branchAnomalies = dataProvider.getAnomaliesByBranch();
    res.json(branchAnomalies);
  } catch (error) {
    console.error('Error getting anomalies by branch:', error);
    res.status(500).json({ error: 'Failed to retrieve branch anomalies' });
  }
});

// Get agencies
app.get('/api/agencies', (req, res) => {
  try {
    const agencies = getAllAgencies();
    res.json(agencies);
  } catch (error) {
    console.error('Error getting agencies:', error);
    res.status(500).json({ error: 'Failed to retrieve agencies' });
  }
});

// Get FATCA statistics
app.get('/api/fatca/stats', async (req, res) => {
  try {
    // Use demo data
    const fatcaStats = dataProvider.getFatcaStats();
    res.json(fatcaStats);
  } catch (error) {
    console.error('Error getting FATCA statistics:', error);
    res.status(500).json({ error: 'Failed to retrieve FATCA statistics' });
  }
});

// Get FATCA clients
app.get('/api/fatca/clients', async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    
    // Use demo data
    const result = dataProvider.getFatcaClients(page, limit);
    res.json(result);
  } catch (error) {
    console.error('Error getting FATCA clients:', error);
    res.status(500).json({ error: 'Failed to retrieve FATCA clients' });
  }
});

// Get corporate FATCA clients
app.get('/api/fatca/corporate', async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const limit = parseInt(req.query.limit) || 10;
    
    // Use demo data - reuse the same data but filter for corporate
    const allClients = dataProvider.getFatcaClients(1, 1000);
    const corporateClients = allClients.data.filter((_, index) => index % 3 === 0).map(client => ({
      ...client,
      raisonSociale: `ENTREPRISE FATCA ${client.cli.substring(3)}`,
      paysImmatriculation: client.pays_naissance,
      paysResidenceFiscale: client.nationalite,
      paysAdresse: client.pays_adresse,
      statusClient: client.status_client,
      dateEntreeRelation: client.date_entree_relation,
      fatcaStatus: client.fatca_status,
      fatcaDate: client.fatca_date,
      fatcaUti: client.fatca_uti
    }));
    
    const start = (page - 1) * limit;
    const end = start + limit;
    
    res.json({
      data: corporateClients.slice(start, end),
      total: corporateClients.length,
      page,
      limit
    });
  } catch (error) {
    console.error('Error getting corporate FATCA clients:', error);
    res.status(500).json({ error: 'Failed to retrieve corporate FATCA clients' });
  }
});

// Get FATCA indicators
app.get('/api/fatca/indicators', async (req, res) => {
  try {
    // Use demo data
    const fatcaIndicators = dataProvider.getFatcaIndicators();
    res.json(fatcaIndicators);
  } catch (error) {
    console.error('Error getting FATCA indicators:', error);
    res.status(500).json({ error: 'Failed to retrieve FATCA indicators' });
  }
});

// Get agency correction stats
app.get('/api/agency-correction-stats', async (req, res) => {
  try {
    // Use demo data
    const agencyCorrectionStats = dataProvider.getAgencyCorrectionStats();
    res.json(agencyCorrectionStats);
  } catch (error) {
    console.error('Error getting agency correction stats:', error);
    res.status(500).json({ error: 'Failed to retrieve agency correction stats' });
  }
});

// Get weekly correction stats
app.get('/api/correction-stats/weekly', async (req, res) => {
  try {
    // Use demo data
    const weeklyCorrectionStats = dataProvider.getWeeklyCorrectionStats();
    res.json(weeklyCorrectionStats);
  } catch (error) {
    console.error('Error getting weekly correction stats:', error);
    res.status(500).json({ error: 'Failed to retrieve weekly correction stats' });
  }
});

// Get data load history
app.get('/api/data-load-history', async (req, res) => {
  try {
    // Use demo data
    const dataLoadHistory = dataProvider.getDataLoadHistory();
    res.json(dataLoadHistory);
  } catch (error) {
    console.error('Error getting data load history:', error);
    res.status(500).json({ error: 'Failed to retrieve data load history' });
  }
});

// Get users by agency
app.get('/api/users/by-agency', authenticateToken, requireRole(['admin', 'auditor']), async (req, res) => {
  try {
    // Use demo data
    const usersByAgency = dataProvider.getUsersByAgency();
    res.json(usersByAgency);
  } catch (error) {
    console.error('Error getting users by agency:', error);
    res.status(500).json({ error: 'Failed to retrieve users by agency' });
  }
});

// Get global tracking data
app.get('/api/tracking/global', authenticateToken, async (req, res) => {
  try {
    // Use demo data
    const globalTrackingData = dataProvider.getGlobalTrackingData();
    res.json(globalTrackingData);
  } catch (error) {
    console.error('Error getting global tracking data:', error);
    res.status(500).json({ error: 'Failed to retrieve global tracking data' });
  }
});

// Clear cache
app.post('/api/cache/clear', authenticateToken, (req, res) => {
  try {
    // In a real application, this would clear any caching mechanism
    res.json({ success: true, message: 'Cache cleared successfully' });
  } catch (error) {
    console.error('Error clearing cache:', error);
    res.status(500).json({ error: 'Failed to clear cache' });
  }
});

// Serve static files in production
if (process.env.NODE_ENV === 'production') {
  app.use(express.static(path.join(__dirname, '../dist')));
}
  
// Always serve the SPA for any route not explicitly handled
app.get('*', (req, res) => {
  if (process.env.NODE_ENV === 'production') {
    res.sendFile(path.join(__dirname, '../dist/index.html'));
  } else {
    // In development, redirect to the dev server
    res.redirect('http://localhost:5175');
  }
});

// Start the server
const server = createServer(app);
server.listen(PORT, '0.0.0.0', async () => {
  console.log(`ðŸš€ Server running at http://0.0.0.0:${PORT}`);
  console.log(`ðŸ“Š Environment: ${process.env.NODE_ENV || 'development'} (Demo Mode)`);
  console.log(`ðŸŒ Access the application at: http://127.0.0.1:${PORT}`);
  console.log('');
  console.log('ðŸŽ­ DEMO MODE ACTIVE: Using fictional data for presentation');
  console.log('');

  console.log('ðŸ” Authentication endpoints:');
  console.log('   â€¢ GET  /api/setup - Database setup');
  console.log('   â€¢ POST /api/auth/login - User login');
  console.log('   â€¢ GET  /api/auth/ldap-config - Get LDAP configuration');
  console.log('   â€¢ POST /api/auth/ldap-config - Update LDAP configuration');
  console.log('   â€¢ POST /api/auth/test-ldap - Test LDAP connection');
  console.log('');

  console.log('ðŸ“‹ Available test accounts:');
  console.log('   â€¢ admin / admin123 (Administrateur)');
  console.log('   â€¢ auditor / audit123 (Auditeur)');
  console.log('   â€¢ user / user123 (Utilisateur)');
  console.log('   â€¢ agency_XXXXX / agencyXXXXX (Utilisateur Agence, oÃ¹ XXXXX est le code agence)');
  console.log('   â€¢ ldap_admin / ldap123 (Administrateur LDAP)');
  console.log('   â€¢ ldap_auditor / ldap123 (Auditeur LDAP)');
  console.log('');

  console.log('ðŸ“Š Data endpoints:');
  console.log('   â€¢ GET  /api/health - Health check');
  console.log('   â€¢ GET  /api/stats/clients - Client statistics');
  console.log('   â€¢ GET  /api/anomalies/individual - Individual anomalies');
  console.log('   â€¢ GET  /api/anomalies/corporate - Corporate anomalies');
  console.log('   â€¢ GET  /api/anomalies/institutional - Institutional anomalies');
  console.log('   â€¢ GET  /api/anomalies/by-branch - Branch anomalies');
  console.log('   â€¢ GET  /api/agencies - Agency list');
  console.log('   â€¢ GET  /api/validation-metrics - Validation metrics');
  console.log('   â€¢ GET  /api/fatca/clients - FATCA clients');
  console.log('   â€¢ GET  /api/fatca/corporate - Corporate FATCA clients');
  console.log('   â€¢ GET  /api/fatca/stats - FATCA statistics');
  console.log('   â€¢ GET  /api/fatca/indicators - FATCA indicators');
  console.log('   â€¢ GET  /api/agency-correction-stats - Agency correction stats');
  console.log('   â€¢ GET  /api/correction-stats/weekly - Weekly correction stats');
  console.log('   â€¢ GET  /api/data-load-history - Data load history');
  console.log('   â€¢ GET  /api/users/by-agency - Users by agency');
  console.log('   â€¢ GET  /api/tracking/global - Global tracking data');
  console.log('');

  // Get local IP addresses for easier access from other devices
  console.log(`ðŸŒ Server accessible at http://localhost:${PORT}`);
  console.log('ðŸ—„ï¸ Database status: Demo mode with fictional data');
});

// Handle graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM signal received: closing HTTP server');
  server.close(() => {
    console.log('HTTP server closed');
  });
});
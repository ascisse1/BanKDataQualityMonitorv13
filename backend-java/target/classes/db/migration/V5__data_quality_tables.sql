CREATE TABLE IF NOT EXISTS anomalies (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    client_number VARCHAR(50) NOT NULL,
    client_name VARCHAR(255) NOT NULL,
    client_type VARCHAR(50) NOT NULL,
    agency_code VARCHAR(20) NOT NULL,
    agency_name VARCHAR(255),
    field_name VARCHAR(100) NOT NULL,
    field_label VARCHAR(255),
    current_value TEXT,
    expected_value TEXT,
    error_type VARCHAR(100),
    error_message TEXT,
    status VARCHAR(50) NOT NULL DEFAULT 'PENDING',
    correction_value TEXT,
    corrected_by VARCHAR(100),
    corrected_at TIMESTAMP,
    validation_comment TEXT,
    validated_by VARCHAR(100),
    validated_at TIMESTAMP,
    ticket_id BIGINT,
    severity VARCHAR(50),
    data_source VARCHAR(100),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_anomaly_client_type (client_type),
    INDEX idx_anomaly_status (status),
    INDEX idx_anomaly_agency (agency_code),
    INDEX idx_anomaly_created (created_at)
);

CREATE TABLE IF NOT EXISTS fatca_clients (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    client_number VARCHAR(50) NOT NULL UNIQUE,
    client_name VARCHAR(255) NOT NULL,
    client_type VARCHAR(50) NOT NULL,
    agency_code VARCHAR(20) NOT NULL,
    agency_name VARCHAR(255),
    fatca_status VARCHAR(50) NOT NULL,
    tax_residence_country VARCHAR(100),
    us_person BOOLEAN DEFAULT FALSE,
    us_tin VARCHAR(50),
    w9_form_received BOOLEAN DEFAULT FALSE,
    w8_form_received BOOLEAN DEFAULT FALSE,
    birth_place VARCHAR(255),
    birth_country VARCHAR(100),
    us_address BOOLEAN DEFAULT FALSE,
    us_phone BOOLEAN DEFAULT FALSE,
    risk_level VARCHAR(50),
    last_review_date DATE,
    next_review_date DATE,
    declaration_date DATE,
    notes TEXT,
    reporting_required BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_fatca_client_type (client_type),
    INDEX idx_fatca_status (fatca_status),
    INDEX idx_fatca_agency (agency_code),
    INDEX idx_fatca_risk_level (risk_level)
);

CREATE TABLE IF NOT EXISTS agencies (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    region VARCHAR(100),
    city VARCHAR(100),
    address TEXT,
    phone VARCHAR(50),
    email VARCHAR(255),
    manager_name VARCHAR(255),
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_agency_code (code),
    INDEX idx_agency_region (region)
);

CREATE TABLE IF NOT EXISTS validation_rules (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    rule_name VARCHAR(255) NOT NULL,
    description TEXT,
    rule_type VARCHAR(50) NOT NULL,
    client_type VARCHAR(50),
    field_name VARCHAR(100) NOT NULL,
    validation_expression TEXT,
    error_message TEXT,
    severity VARCHAR(50),
    active BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0,
    created_by VARCHAR(100),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_rule_type (rule_type),
    INDEX idx_rule_client_type (client_type),
    INDEX idx_rule_active (active)
);

CREATE TABLE IF NOT EXISTS data_load_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    file_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(50),
    file_size BIGINT,
    records_total INT,
    records_processed INT,
    records_success INT,
    records_failed INT,
    anomalies_detected INT,
    status VARCHAR(50) NOT NULL,
    error_message TEXT,
    uploaded_by VARCHAR(100),
    processing_time_ms BIGINT,
    load_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_load_status (status),
    INDEX idx_load_date (load_date)
);

CREATE TABLE IF NOT EXISTS correction_stats (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    agency_code VARCHAR(20) NOT NULL,
    agency_name VARCHAR(255),
    stats_date DATE NOT NULL,
    week_number INT,
    month_number INT,
    year_number INT,
    total_anomalies INT DEFAULT 0,
    corrected_anomalies INT DEFAULT 0,
    validated_anomalies INT DEFAULT 0,
    pending_anomalies INT DEFAULT 0,
    correction_rate DOUBLE,
    avg_correction_time_hours DOUBLE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_stats_agency (agency_code),
    INDEX idx_stats_date (stats_date)
);
